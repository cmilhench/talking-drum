<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>
  <link href='http://fonts.googleapis.com/css?family=Cousine:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='index.css' rel='stylesheet' type='text/css'>
</head>
<body>
  <div class="container">
    <div data-bind="foreach: channels">
      <div id="%s" class="panel panel-default">
          <div class="panel-heading">
            <strong data-bind="text: name">%name</strong>
            <span>&nbsp;&mdash;&nbsp;</span>
            <span title="%topic" data-bind="text: topic, attr: { title: topic }">%topic</span>
            <textarea data-bind="submit: message, event: { keypress: $root.sendMessage }"></textarea>
          </div>
          <ol class="panel-body list-group" data-bind="foreach: messages">
            <li>
              <blockquote>
                <header>
                  <cite class="author" data-bind="text: from">%from</cite>&nbsp;
                  <time title="%date" data-bind="text: time, attr: { title: date }">%time</time>
                </header>
                <p data-bind="text: text"></p>
              </blockquote>
            </li>
          </ol>
          <div class="panel-footer">
          </div>
      </div>
    </div>
  </div>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.8.3.min.js"><\/script>')</script>
  <script src="/socket.io/socket.io.js"></script> 
  <script src="/vendor/knockout/knockout-latest.js"></script>
  <script src="/vendor/eventemitter/emitter.js"></script>
  <script src="/js/parser.js"></script>
  <script src="/js/client.js"></script>
  <script>
  
    function MessageViewModel(from, text, when) {
      var self = this;
      self.from = ko.observable(from);
      self.text = ko.observable(text);
      self.when = ko.observable(when);
      self.date = ko.computed(function(){
        return new Date(self.when()).toISOString();
      });
      self.time = ko.computed(function(){
        return self.date().substr(11,5);
      });
    }

    function ChannelViewModel(name, topic, names) {
      var self = this;
      self.name = ko.observable(name);
      self.topic = ko.observable(topic);
      self.names = ko.observableArray(names);
      self.messages = ko.observableArray([]);
    }

    function MainViewModel() {
      this.me = ko.observable();
      this.channels = ko.observableArray([]);
    }
    MainViewModel.prototype.addChannel = function(name){
      this.channels.push(new ChannelViewModel(name));
    }
    MainViewModel.prototype.addMessage = function(message){
      var self = this;
      var channel = self.channels().filter(function(channel){ 
        return channel.name() === message.to; 
      })[0];
      if (!channel) {
        self.addChannel(message.to)
        return self.addMessage(message);
      }
      channel.messages.push(new MessageViewModel(message.from, message.message, message.when));
    }
    MainViewModel.prototype.sendMessage = function(model, event){
      var self = this;
      if (event.which !== 13) {
          return true;
      }
      var context = ko.contextFor(event.target);
      var send = {
        from: context.$root.me(),
        to: model.name(),
        message: event.target.value,
        when: (+new Date())
      }
      console.log(send);
      event.target.value = '';
    }

    
    var vm = new MainViewModel();
    ko.applyBindings(vm);
    
    var repo = [
      { to:'#talking-drum', from: 'cmilhench', message: 'Hello', when:1384157989787},
      { to:'#talking-drum', from: 'colinm', message: 'Hello', when:1384157990787},
      { to:'#talking-drum', from: 'colinm', message: 'How\'s it going?', when:1384157999787},
      { to:'#talking-drum', from: 'colinm', message: 'Long time no see', when:1384158100787},
      { to:'#talking-drum', from: 'cmilhench', message: 'Yeah, good', when:1384158110787},
      { to:'#talking-drum', from: 'colinm', message: 'how\'s the irc client coming?', when:1384158120787},
      { to:'#talking-drum', from: 'cmilhench', message: 'Awesome', when:1384158130787}
    ];
    function message(){
      var m = repo.shift();
      vm.addMessage(m);
      if (repo.length) {
        setTimeout(message, 1000);
      }
    }
    setTimeout(message, 10);

  </script>
</body>
</html>
